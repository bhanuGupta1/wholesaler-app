import{u as W,a as H,h as K,r as m,c as q,d as S,q as N,n as G,l as k,w as F,g as R,j as e,s as Y,p as J,k as X,e as Z}from"./index-BBVZjf1E.js";import{u as _}from"./useAccessControl-Cp7aINs-.js";import{I as ee}from"./ImageUploader-d-gMjT6N.js";const ae=()=>{const{darkMode:t}=W(),{user:s}=H(),{canManageProducts:f,userAccessLevel:$,isAdmin:x,isManager:u,isSeller:c}=_(),p=K(),[o,A]=m.useState({name:"",description:"",price:"",stock:"",category:"",imageUrl:"",sku:""}),[j,D]=m.useState(!1),[B,g]=m.useState(null),[U,w]=m.useState(!1),[v,P]=m.useState([]),[I,E]=m.useState(!1),[C,L]=m.useState(new Set),h=x||u,O=["Electronics","Office Supplies","Furniture","Home & Garden","Health & Beauty","Automotive","Sports & Recreation","Books & Media","Clothing & Accessories","Tools & Hardware","Other"];m.useEffect(()=>{f&&M()},[f,s]);const M=async()=>{E(!0);try{const r=q(S,"products");let i;x||u?i=N(r,G("createdAt","desc"),k(5)):c&&(s!=null&&s.uid)?i=N(r,F("createdBy","==",s.uid),k(5)):i=N(r,F("createdBy","==",(s==null?void 0:s.uid)||"none"),k(5));const d=(await R(i)).docs.map(n=>{var b;const a=n.data();return{id:n.id,name:a.name||"Unnamed Product",description:a.description||"",price:a.price||0,stock:a.stock||a.stockQuantity||0,category:a.category||"Uncategorized",imageUrl:a.imageUrl||"",sku:a.sku||"",createdBy:a.createdBy||"unknown",ownedBy:a.ownedBy||a.createdBy||"unknown",createdByEmail:a.createdByEmail||"unknown",createdAt:((b=a.createdAt)==null?void 0:b.toDate())||new Date}});!x&&!u&&d.sort((n,a)=>a.createdAt-n.createdAt),console.log(`üì¶ Successfully fetched ${d.length} recent products for ${$}`),P(d)}catch(r){if(console.error("Error fetching recent products:",r),(r.code==="failed-precondition"||r.message.includes("index"))&&(console.log("Firestore indexing issue, trying simpler query for recent products..."),(c||!x)&&(s!=null&&s.uid)))try{const i=N(productsRef,F("createdBy","==",s.uid),k(5)),d=(await R(i)).docs.map(n=>{var b;const a=n.data();return{id:n.id,name:a.name||"Unnamed Product",description:a.description||"",price:a.price||0,stock:a.stock||a.stockQuantity||0,category:a.category||"Uncategorized",imageUrl:a.imageUrl||"",sku:a.sku||"",createdBy:a.createdBy||"unknown",ownedBy:a.ownedBy||a.createdBy||"unknown",createdByEmail:a.createdByEmail||"unknown",createdAt:((b=a.createdAt)==null?void 0:b.toDate())||new Date}});d.sort((n,a)=>a.createdAt-n.createdAt),P(d);return}catch(i){console.error("Simple query also failed:",i)}}finally{E(!1)}},z=async(r,i)=>{if(!h){const d=v.find(n=>n.id===r);if(!d||d.createdBy!==(s==null?void 0:s.uid)&&d.ownedBy!==(s==null?void 0:s.uid)){g("You can only delete products you created");return}}if(window.confirm(`Are you sure you want to delete "${i}"? This action cannot be undone.`)){L(d=>new Set(d).add(r));try{await X(Z(S,"products",r)),P(d=>d.filter(n=>n.id!==r)),w(!0),setTimeout(()=>w(!1),3e3)}catch(d){console.error("Error deleting product:",d),g("Failed to delete product. Please try again.")}finally{L(d=>{const n=new Set(d);return n.delete(r),n})}}};if(!f)return e.jsx("div",{className:`container mx-auto px-4 py-8 ${t?"text-gray-200":"text-gray-800"}`,children:e.jsxs("div",{className:`max-w-md mx-auto text-center p-8 ${t?"bg-gray-800":"bg-white"} rounded-xl shadow-lg`,children:[e.jsx("div",{className:"text-6xl mb-4",children:"üö´"}),e.jsx("h2",{className:`text-2xl font-bold mb-4 ${t?"text-white":"text-gray-900"}`,children:"Access Denied"}),e.jsx("p",{className:`mb-4 ${t?"text-gray-300":"text-gray-600"}`,children:"You need seller, manager, or admin permissions to add products."}),e.jsx("div",{className:`p-3 rounded-lg mb-6 ${t?"bg-gray-700":"bg-gray-50"}`,children:e.jsxs("p",{className:`text-sm ${t?"text-gray-400":"text-gray-500"}`,children:["Current access level: ",e.jsx("span",{className:"font-medium",children:$})]})}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("button",{onClick:()=>p("/catalog"),className:"block w-full py-2 px-4 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors",children:"Browse Products"}),e.jsx("button",{onClick:()=>p(-1),className:`block w-full py-2 px-4 border rounded-lg transition-colors ${t?"border-gray-600 text-gray-300 hover:bg-gray-700":"border-gray-300 text-gray-700 hover:bg-gray-50"}`,children:"Go Back"})]})]})});const y=r=>{const{name:i,value:l}=r.target;A(d=>({...d,[i]:l})),B&&g(null),U&&w(!1)},T=()=>o.name.trim()?!o.price||parseFloat(o.price)<=0?"Valid price is required":!o.stock||parseInt(o.stock)<0?"Valid stock quantity is required":o.category?null:"Category is required":"Product name is required",V=async r=>{r.preventDefault();const i=T();if(i){g(i);return}D(!0),g(null);try{const l=parseFloat(o.price),d=parseInt(o.stock),n={name:o.name.trim(),description:o.description.trim()||"",price:l,stock:d,stockQuantity:d,category:o.category,imageUrl:o.imageUrl.trim()||"",sku:o.sku.trim()||"",createdBy:s.uid,ownedBy:s.uid,createdByEmail:s.email,businessId:s.uid,businessName:s.businessName||s.displayName||"",createdAt:Y(),updatedAt:Y(),isApproved:!0,status:"active",bulkPricing:{10:+(l*.9).toFixed(2),50:+(l*.85).toFixed(2),100:+(l*.8).toFixed(2)},reorderPoint:Math.max(5,Math.floor(d*.1)),supplier:s.businessName||s.displayName||"",tags:[o.category.toLowerCase(),o.name.toLowerCase().split(" ")[0]]},a=await J(q(S,"products"),n);console.log("Product added with ID:",a.id),console.log("Product data:",n),w(!0),A({name:"",description:"",price:"",stock:"",category:"",imageUrl:"",sku:""}),setTimeout(()=>{p("/inventory")},2e3),M()}catch(l){console.error("Error adding product:",l),g("Failed to add product. Please try again.")}finally{D(!1)}},Q=()=>{p("/inventory")};return e.jsxs("div",{className:`container mx-auto px-4 py-8 max-w-2xl ${t?"text-gray-200":"text-gray-800"}`,children:[e.jsxs("div",{className:"mb-8",children:[e.jsx("h1",{className:`text-3xl font-bold ${t?"text-white":"text-gray-900"}`,children:"Add New Product"}),e.jsx("p",{className:`mt-1 text-sm ${t?"text-gray-400":"text-gray-500"}`,children:"Add a new product to your inventory with automatic ownership tracking"}),e.jsxs("div",{className:"mt-2 flex items-center space-x-2",children:[e.jsxs("div",{className:`inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${t?"bg-green-900/30 text-green-400":"bg-green-100 text-green-800"}`,children:["‚úÖ ",$," Access"]}),e.jsxs("div",{className:`inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${t?"bg-blue-900/30 text-blue-400":"bg-blue-100 text-blue-800"}`,children:["üë§ Owner: ",(s==null?void 0:s.displayName)||(s==null?void 0:s.email)||"You"]})]})]}),U&&e.jsx("div",{className:`mb-6 p-4 rounded-lg ${t?"bg-green-900/20 border-green-800 text-green-400":"bg-green-50 border-green-200 text-green-800"} border`,children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("svg",{className:"h-5 w-5 mr-2",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M5 13l4 4L19 7"})}),"Product added successfully with ownership tracking! Redirecting to inventory..."]})}),B&&e.jsx("div",{className:`mb-6 p-4 rounded-lg ${t?"bg-red-900/20 border-red-800 text-red-400":"bg-red-50 border-red-200 text-red-800"} border`,children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("svg",{className:"h-5 w-5 mr-2",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"})}),B]})}),e.jsx("div",{className:`${t?"bg-gray-800 border-gray-700":"bg-white border-gray-200"} rounded-xl shadow-lg border`,children:e.jsxs("form",{onSubmit:V,className:"p-6 space-y-6",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"name",className:`block text-sm font-medium ${t?"text-gray-300":"text-gray-700"} mb-2`,children:"Product Name *"}),e.jsx("input",{type:"text",id:"name",name:"name",value:o.name,onChange:y,className:`w-full px-3 py-2 border rounded-md ${t?"bg-gray-700 border-gray-600 text-gray-200 placeholder-gray-400":"bg-white border-gray-300 text-gray-900"} focus:ring-indigo-500 focus:border-indigo-500`,placeholder:"Enter product name",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"sku",className:`block text-sm font-medium ${t?"text-gray-300":"text-gray-700"} mb-2`,children:"SKU (Stock Keeping Unit)"}),e.jsx("input",{type:"text",id:"sku",name:"sku",value:o.sku,onChange:y,className:`w-full px-3 py-2 border rounded-md ${t?"bg-gray-700 border-gray-600 text-gray-200 placeholder-gray-400":"bg-white border-gray-300 text-gray-900"} focus:ring-indigo-500 focus:border-indigo-500`,placeholder:"Enter SKU (optional)"})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"description",className:`block text-sm font-medium ${t?"text-gray-300":"text-gray-700"} mb-2`,children:"Description"}),e.jsx("textarea",{id:"description",name:"description",value:o.description,onChange:y,rows:3,className:`w-full px-3 py-2 border rounded-md ${t?"bg-gray-700 border-gray-600 text-gray-200 placeholder-gray-400":"bg-white border-gray-300 text-gray-900"} focus:ring-indigo-500 focus:border-indigo-500`,placeholder:"Enter product description (optional)"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"price",className:`block text-sm font-medium ${t?"text-gray-300":"text-gray-700"} mb-2`,children:"Price ($) *"}),e.jsx("input",{type:"number",id:"price",name:"price",value:o.price,onChange:y,step:"0.01",min:"0",className:`w-full px-3 py-2 border rounded-md ${t?"bg-gray-700 border-gray-600 text-gray-200 placeholder-gray-400":"bg-white border-gray-300 text-gray-900"} focus:ring-indigo-500 focus:border-indigo-500`,placeholder:"0.00",required:!0}),o.price&&e.jsxs("p",{className:`text-xs mt-1 ${t?"text-gray-400":"text-gray-500"}`,children:["Bulk pricing: 10+ units: $",(parseFloat(o.price)*.9).toFixed(2),", 50+ units: $",(parseFloat(o.price)*.85).toFixed(2),", 100+ units: $",(parseFloat(o.price)*.8).toFixed(2)]})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"stock",className:`block text-sm font-medium ${t?"text-gray-300":"text-gray-700"} mb-2`,children:"Stock Quantity *"}),e.jsx("input",{type:"number",id:"stock",name:"stock",value:o.stock,onChange:y,min:"0",className:`w-full px-3 py-2 border rounded-md ${t?"bg-gray-700 border-gray-600 text-gray-200 placeholder-gray-400":"bg-white border-gray-300 text-gray-900"} focus:ring-indigo-500 focus:border-indigo-500`,placeholder:"0",required:!0}),o.stock&&e.jsxs("p",{className:`text-xs mt-1 ${t?"text-gray-400":"text-gray-500"}`,children:["Auto reorder point: ",Math.max(5,Math.floor(parseInt(o.stock)*.1))," units"]})]})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"category",className:`block text-sm font-medium ${t?"text-gray-300":"text-gray-700"} mb-2`,children:"Category *"}),e.jsxs("select",{id:"category",name:"category",value:o.category,onChange:y,className:`w-full px-3 py-2 border rounded-md ${t?"bg-gray-700 border-gray-600 text-gray-200":"bg-white border-gray-300 text-gray-900"} focus:ring-indigo-500 focus:border-indigo-500`,required:!0,children:[e.jsx("option",{value:"",children:"Select a category"}),O.map(r=>e.jsx("option",{value:r,children:r},r))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:`block text-sm font-medium mb-2 ${t?"text-gray-300":"text-gray-700"}`,children:"Product Image"}),e.jsx(ee,{initialImage:o.imageUrl,onImageUploaded:r=>A(i=>({...i,imageUrl:r})),folder:"product-images",customId:s==null?void 0:s.uid,darkMode:t,autoUpload:!0})]}),e.jsxs("div",{className:"flex justify-end space-x-4 pt-4 border-t border-gray-200 dark:border-gray-700",children:[e.jsx("button",{type:"button",onClick:Q,className:`px-4 py-2 border rounded-md font-medium ${t?"border-gray-600 text-gray-300 hover:bg-gray-700":"border-gray-300 text-gray-700 hover:bg-gray-50"} transition-colors`,disabled:j,children:"Cancel"}),e.jsxs("button",{type:"submit",disabled:j,className:"px-6 py-2 bg-indigo-600 text-white rounded-md font-medium hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors flex items-center",children:[j&&e.jsxs("svg",{className:"animate-spin -ml-1 mr-2 h-4 w-4 text-white",fill:"none",viewBox:"0 0 24 24",children:[e.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),e.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]}),j?"Adding Product...":"Add Product"]})]})]})}),e.jsx("div",{className:`mt-6 p-4 rounded-lg ${t?"bg-blue-900/20 border-blue-800":"bg-blue-50 border-blue-200"} border`,children:e.jsxs("div",{className:"flex items-start",children:[e.jsx("svg",{className:`h-5 w-5 ${t?"text-blue-400":"text-blue-600"} mt-0.5 mr-3`,fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"})}),e.jsxs("div",{children:[e.jsx("h3",{className:`text-sm font-medium ${t?"text-blue-300":"text-blue-800"} mb-1`,children:"Ownership & Permissions"}),e.jsxs("ul",{className:`text-sm ${t?"text-blue-200":"text-blue-700"} space-y-1`,children:[e.jsx("li",{children:"‚Ä¢ Products you create will be automatically owned by you"}),e.jsx("li",{children:"‚Ä¢ Automatic bulk pricing tiers will be applied (10%, 15%, 20% discounts)"}),e.jsxs("li",{children:["‚Ä¢ ",c?"As a seller, only you can edit/delete your products":x||u?"As admin/manager, you can manage all products":"You can manage your own products"]}),e.jsx("li",{children:"‚Ä¢ Products will be immediately available in the inventory"})]})]})]})}),f&&e.jsxs("div",{className:`mt-8 ${t?"bg-gray-800 border-gray-700":"bg-white border-gray-200"} rounded-xl shadow-lg border`,children:[e.jsxs("div",{className:`px-6 py-4 border-b ${t?"border-gray-700":"border-gray-200"} flex justify-between items-center`,children:[e.jsxs("div",{children:[e.jsx("h3",{className:`text-lg font-semibold ${t?"text-white":"text-gray-900"}`,children:c?"My Recent Products":"Recently Added Products"}),e.jsx("p",{className:`text-sm ${t?"text-gray-400":"text-gray-500"}`,children:x||u?"All recent products (Admin/Manager View)":c?"Your recent product listings":"Your recent products"})]}),v.length>0&&e.jsx("div",{className:`px-2 py-1 rounded-full text-xs font-medium ${h?t?"bg-red-900/30 text-red-400":"bg-red-100 text-red-800":t?"bg-blue-900/30 text-blue-400":"bg-blue-100 text-blue-800"}`,children:h?"üóëÔ∏è Delete Access":"üëÅÔ∏è View Only"})]}),e.jsxs("div",{className:"p-6",children:[I?e.jsxs("div",{className:"flex justify-center items-center py-8",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-indigo-500"}),e.jsx("span",{className:`ml-3 ${t?"text-gray-400":"text-gray-500"}`,children:"Loading recent products..."})]}):v.length===0?e.jsxs("div",{className:"text-center py-8",children:[e.jsx("div",{className:`text-4xl mb-3 ${t?"text-gray-600":"text-gray-400"}`,children:"üì¶"}),e.jsx("p",{className:`${t?"text-gray-400":"text-gray-500"} mb-2`,children:c?"No products created yet":"No recent products to display"}),e.jsx("p",{className:`text-sm ${t?"text-gray-500":"text-gray-400"}`,children:c?"Add your first product above to start selling":"Products you create will appear here"})]}):e.jsx("div",{className:"space-y-3",children:v.map(r=>{var i;return e.jsxs("div",{className:`flex items-center justify-between p-4 rounded-lg border ${t?"border-gray-700 bg-gray-700/50":"border-gray-200 bg-gray-50"}`,children:[e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsx("div",{className:`w-12 h-12 rounded-lg ${t?"bg-gray-600":"bg-gray-200"} flex items-center justify-center overflow-hidden`,children:r.imageUrl?e.jsx("img",{src:r.imageUrl,alt:r.name,className:"w-full h-full object-cover"}):e.jsx("span",{className:"text-2xl",children:"üì¶"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h4",{className:`font-medium ${t?"text-white":"text-gray-900"}`,children:r.name}),e.jsxs("div",{className:"flex items-center space-x-4 mt-1",children:[e.jsxs("span",{className:`text-sm ${t?"text-gray-400":"text-gray-500"}`,children:["$",(i=r.price)==null?void 0:i.toFixed(2)," ‚Ä¢ Stock: ",r.stock]}),e.jsx("span",{className:`px-2 py-1 rounded-full text-xs font-medium ${t?"bg-blue-900/30 text-blue-400":"bg-blue-100 text-blue-800"}`,children:r.category})]}),e.jsxs("p",{className:`text-xs ${t?"text-gray-500":"text-gray-400"} mt-1`,children:["Added ",r.createdAt.toLocaleDateString()," at ",r.createdAt.toLocaleTimeString(),(x||u)&&r.createdBy!==s.uid&&e.jsxs("span",{className:`ml-2 px-1 py-0.5 rounded text-xs ${t?"bg-purple-900/30 text-purple-400":"bg-purple-100 text-purple-700"}`,children:["by ",r.createdByEmail||"other user"]}),r.createdBy===s.uid&&e.jsx("span",{className:`ml-2 px-1 py-0.5 rounded text-xs ${t?"bg-green-900/30 text-green-400":"bg-green-100 text-green-700"}`,children:"by you"})]})]})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("button",{onClick:()=>p(`/products/${r.id}`),className:`px-3 py-1 text-sm rounded-md ${t?"text-blue-400 hover:bg-blue-900/20":"text-blue-600 hover:bg-blue-50"} transition-colors`,children:"View"}),(h||r.createdBy===(s==null?void 0:s.uid))&&e.jsx("button",{onClick:()=>z(r.id,r.name),disabled:C.has(r.id),className:`px-3 py-1 text-sm rounded-md transition-colors ${C.has(r.id)?"opacity-50 cursor-not-allowed bg-gray-400 text-white":t?"text-red-400 hover:bg-red-900/20 border border-red-800":"text-red-600 hover:bg-red-50 border border-red-200"}`,children:C.has(r.id)?e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-3 w-3 border-t border-b border-white mr-1"}),"Deleting..."]}):"üóëÔ∏è Delete"})]})]},r.id)})}),e.jsx("div",{className:`mt-4 p-3 rounded-lg ${t?"bg-yellow-900/20 border-yellow-800":"bg-yellow-50 border-yellow-200"} border`,children:e.jsxs("div",{className:"flex items-start",children:[e.jsx("svg",{className:`h-5 w-5 ${t?"text-yellow-400":"text-yellow-600"} mt-0.5 mr-2`,fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16c-.77.833.192 2.5 1.732 2.5z"})}),e.jsxs("div",{children:[e.jsx("h4",{className:`text-sm font-medium ${t?"text-yellow-300":"text-yellow-800"} mb-1`,children:"üîê Ownership & Access Control"}),e.jsx("p",{className:`text-sm ${t?"text-yellow-200":"text-yellow-700"}`,children:h?e.jsxs(e.Fragment,{children:[e.jsx("strong",{children:"Admin/Manager Access:"})," You can view all products and delete any product. Deleted products cannot be recovered."]}):c?e.jsxs(e.Fragment,{children:[e.jsx("strong",{children:"Seller Access:"})," You can only view and manage products you created. Only you and administrators can delete your products."]}):e.jsxs(e.Fragment,{children:[e.jsx("strong",{children:"User Access:"})," You can view and manage products you created. Only administrators and managers can delete products created by others."]})})]})]})})]})]})]})};export{ae as default};
